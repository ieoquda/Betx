<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BETX â€” Mines</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ---------- enhanced vibrant casino styles (keeps original layout) ---------- */
    :root{
      --bg1:#07122a; --bg2:#0f1530; --card: rgba(255,255,255,0.04);
      --accent:#ffd24d; --accent-glow:#fff2a8; --text:#f6f7fb; --muted:#bfc7d6;
      --gold1:#ffd54a; --gold2:#ff8f00; --green:#2ecc71; --red:#ff5c6c;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:'Poppins',sans-serif;background:
      radial-gradient(1000px 600px at 10% 10%, rgba(255,213,79,0.05), transparent 10%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);min-height:100vh; -webkit-font-smoothing:antialiased}
    .container{max-width:980px;margin:18px auto;padding:18px}
    .center{display:flex;align-items:center;justify-content:center}
    .hidden{display:none}
    button{cursor:pointer;border:0;outline:0}
    /* Card / Auth */
    .card{
      width:100%; max-width:460px; margin:12px auto; background: var(--card);
      padding:26px;border-radius:14px; box-shadow:0 10px 40px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
    }
    .logo{font-size:38px;font-weight:800;color:var(--accent);text-align:center;margin-bottom:12px;
      text-shadow:0 0 18px rgba(255,210,80,0.16)}
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .tab-btn{flex:1;padding:10px;border-radius:10px;text-align:center;background:transparent;color:var(--muted);font-weight:600}
    .tab-btn.active{background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#0b0810;box-shadow:0 6px 24px rgba(255,180,30,0.12)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .field{width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:var(--text);margin-bottom:10px;outline:none}
    .submit{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#0b0810;font-weight:800;box-shadow:0 6px 18px rgba(255,160,30,0.14)}
    header.appHeader{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
    .brand{font-size:44px;font-weight:800;color:var(--gold1);text-shadow:0 0 18px rgba(255,215,0,0.12);text-align:center;margin-bottom:14px}
    .menu-card{width:380px;max-width:100%;background:var(--glass-2);padding:18px;border-radius:14px;display:flex;flex-direction:column;gap:12px;align-items:center;margin:0 auto;border:1px solid rgba(255,255,255,0.02)}
    .btn{width:100%;padding:12px;border-radius:12px;font-weight:800;font-size:16px; background:linear-gradient(90deg,var(--gold1),var(--gold2)); color:#0b0810;box-shadow:0 10px 30px rgba(255,170,20,0.08)}
    .btn.secondary{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .btn.logout{width:160px;background:linear-gradient(90deg,#ff6b6b,#d82b2b);color:#fff}
    .small{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center}
    /* game styles */
    .game-root{max-width:520px;margin:16px auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.02)}
    .header-game{display:flex;justify-content:space-between;align-items:center;padding:16px;background: linear-gradient(90deg, rgba(0,0,0,0.25), rgba(255,255,255,0.01));border-bottom:1px solid rgba(255,255,255,0.02)}
    .logo-game{font-weight:800;letter-spacing:1px;color:var(--gold1)}
    .balance{font-weight:800;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px 12px;border-radius:10px}
    .grid{margin:18px auto;display:grid;grid-template-columns:repeat(3,96px);gap:14px;padding:12px;justify-content:center}
    .cell{width:96px;height:96px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:34px;cursor:pointer;position:relative;user-select:none;transition:all .18s, transform .12s;}
    .cell:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .cell.revealed{cursor:default;background:linear-gradient(180deg,#1e293b,#111827);transform:none}
    .cell.blast::after{content:"";position:absolute;width:100%;height:100%;border-radius:14px;background:rgba(255,92,108,0.45);animation:blast 0.45s ease forwards}
    @keyframes blast{0%{transform:scale(0.6);opacity:1}100%{transform:scale(1.6);opacity:0}}
    .diamond{filter: drop-shadow(0 6px 18px rgba(80,220,255,0.08))}
    .bet-panel{padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));display:flex;flex-direction:column;gap:12px;border-top:1px solid rgba(255,255,255,0.02)}
    .bet-row{display:flex;gap:8px}
    .bet-input{flex:1;padding:12px;border-radius:10px;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.02);color:var(--text)}
    .quick-btn{padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,#1f2937,#111827);border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
    .bet-btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--green),#21a85a);color:#fff;font-weight:800;box-shadow:0 12px 30px rgba(34,197,94,0.08)}
    .popup-msg{position:fixed;left:50%;transform:translateX(-50%);top:18px;padding:10px 14px;border-radius:8px;font-weight:700;z-index:40}
    .popup-win{background:linear-gradient(90deg,#16a34a,#10b981)} .popup-lose{background:linear-gradient(90deg,#ef4444,#f97316)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,0.72);color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transition:all .25s}
    .toast.show{opacity:1;bottom:40px}
    .link-like{color:var(--accent);text-decoration:underline;cursor:pointer}
    .section-title{font-weight:800;margin:10px 0;color:var(--muted)}
    .account-num{font-size:13px;color:var(--muted);text-align:center;margin-top:8px}
    .glow { text-shadow: 0 0 10px rgba(255,215,0,0.18); }
    .confetti { position: absolute; left: 50%; transform: translateX(-50%); top: 8px; pointer-events:none; }
    @media(max-width:600px){ .grid{grid-template-columns:repeat(3,72px)} .cell{width:72px;height:72px;font-size:22px} .brand{font-size:34px} }
  </style>
</head>
<body>

  <div class="container">

    <!-- LOGIN / REGISTER view -->
    <div id="authView" class="center">
      <div class="card" id="authCard">
        <div class="logo">BETX</div>
        <div class="tabs">
          <div id="loginTab" class="tab-btn">Login</div>
          <div id="registerTab" class="tab-btn active">Register</div>
        </div>

        <!-- Login form -->
        <form id="loginForm" class="hidden">
          <label>Email</label>
          <input id="loginEmail" class="field" type="email" placeholder="you@example.com" required>
          <label>Password</label>
          <input id="loginPassword" class="field" type="password" placeholder="Password" required>
          <button type="submit" class="submit">Login</button>
        </form>

        <!-- Register form -->
        <form id="registerForm">
          <label>Email</label>
          <input id="regEmail" class="field" type="email" placeholder="you@example.com" required>
          <label>Password (min 6)</label>
          <input id="regPassword" class="field" type="password" placeholder="Password" minlength="6" required>
          <button type="submit" class="submit">Register</button>
        </form>

        <p class="small" style="margin-top:10px;text-align:center">By registering you agree to BETX terms.</p>
        <div id="newAccount" class="account-num hidden"></div>
      </div>
    </div>

    <!-- APP Root (home + pages) -->
    <div id="appView" class="hidden">

      <div class="brand glow">BETX</div>

      <header class="appHeader">
        <div id="accountLabel">Account - â€”</div>
        <div id="amountLabel">Amount - â€”</div>
      </header>

      <div class="menu-wrap">
        <div class="menu-card">
          <button id="gamesBtn" class="btn">GAMES</button>
          <button id="esportsBtn" class="btn secondary">ESPORTS</button>
          <button id="depositBtn" class="btn secondary">DEPOSIT</button>
          <button id="withdrawBtn" class="btn secondary">WITHDRAW</button>
          <button id="historyBtn" class="btn secondary">HISTORY</button>
          <div style="height:8px"></div>
          <!-- admin button removed as requested -->
          <button id="logoutBtn" class="btn logout">LOGOUT</button>
        </div>
      </div>

      <!-- Dynamic page container -->
      <div id="pageContainer">

        <!-- HOME / WELCOME -->
        <div id="homePage" style="margin-top:18px">
          <div class="section-title">Welcome back</div>
          <p class="small">Choose Games to play Mines or check deposit/withdraw steps.</p>
        </div>

        <!-- MINES GAME PAGE -->
        <div id="minesPage" class="hidden">
          <div class="game-root">
            <div class="header-game">
              <div class="logo-game">BetX Mines</div>
              <div class="balance">â‚¨ <span id="gameBalance">0.00</span></div>
            </div>

            <div class="grid" id="grid"></div>

            <div class="bet-panel">
              <div class="label small">Bet Amount (min 30)</div>
              <div class="bet-row">
                <input id="betAmount" class="bet-input" type="number" placeholder="0.00" min="30">
                <button class="quick-btn" id="halfBtn">1/2</button>
                <button class="quick-btn" id="doubleBtn">2x</button>
              </div>

              <div class="label small">Mines</div>
              <div class="mines-row" style="display:flex;gap:8px;align-items:center">
                <select id="minesCount" class="bet-input" style="width:120px">
                  <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                </select>
                <div style="flex:1"></div>
                <div id="instantMultiplier" class="small" style="text-align:right;color:var(--muted)">x1.00</div>
              </div>

              <div style="display:flex;gap:8px">
                <button id="betBtn" class="bet-btn">Bet</button>
                <button id="cashoutBtn" class="bet-btn" style="background:linear-gradient(90deg,#2563eb,#1d4ed8);display:none">Cashout</button>
              </div>

              <div style="margin-top:8px;font-size:14px;color:var(--gold1)" id="cashoutInfo"></div>
            </div>
          </div>
        </div>

        <!-- DEPOSIT / WITHDRAW simple view -->
        <div id="depositPage" class="hidden" style="margin-top:16px">
          <div class="section-title">Deposit â€” Steps</div>
          <ol>
            <li>Open Telegram link below.</li>
            <li>Send a message to the admin with your registered email and amount.</li>
            <li>Follow admin instructions and make payment.</li>
            <li>Admin will credit your account after confirmation.</li>
          </ol>
          <p>Telegram: <a id="tgLink" class="link-like" href="https://t.me/betxgroupnepal" target="_blank">https://t.me/betxgroupnepal</a></p>
        </div>

        <div id="withdrawPage" class="hidden" style="margin-top:16px">
          <div class="section-title">Withdraw â€” Steps</div>
          <ol>
            <li>Open Telegram link below.</li>
            <li>Send a withdrawal request with amount and your registered email.</li>
            <li>Admin will verify and process payout.</li>
            <li>Payouts processed manually by admin.</li>
          </ol>
          <p>Telegram: <a id="tgLink2" class="link-like" href="https://t.me/betxgroupnepal" target="_blank">https://t.me/betxgroupnepal</a></p>
        </div>

        <!-- ESPORTS -->
        <div id="esportsPage" class="hidden" style="margin-top:16px">
          <div class="section-title">eSports</div>
          <p class="small">Coming soon â€” big tournaments and odds are under development.</p>
        </div>

        <!-- HISTORY -->
        <div id="historyPage" class="hidden" style="margin-top:16px">
          <div class="section-title">History</div>
          <div id="historyList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>

      </div>
    </div>

  </div>

  <div id="popup" class="popup-msg hidden"></div>
  <div id="toast" class="toast"></div>

  <!-- Firebase (modular) SDKs via CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp,
      collection, addDoc, query, orderBy, getDocs, runTransaction, onSnapshot, where
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // ---------- firebase config (saved to memory) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCv3gDLEUhuHdMDPc2RX2AzLvihDfmEXgo",
      authDomain: "betx-74dff.firebaseapp.com",
      projectId: "betx-74dff",
      storageBucket: "betx-74dff.firebasestorage.app",
      messagingSenderId: "85279852822",
      appId: "1:85279852822:web:91ef8dad8794d820416837",
      measurementId: "G-NX5D0BF329"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e){ /* analytics might fail in some env */ }

    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- UI refs ----------
    const authView = document.getElementById('authView');
    const appView = document.getElementById('appView');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const accountLabel = document.getElementById('accountLabel');
    const amountLabel = document.getElementById('amountLabel');
    const toast = document.getElementById('toast');
    const popup = document.getElementById('popup');
    const newAccountEl = document.getElementById('newAccount');

    // pages
    const homePage = document.getElementById('homePage');
    const minesPage = document.getElementById('minesPage');
    const depositPage = document.getElementById('depositPage');
    const withdrawPage = document.getElementById('withdrawPage');
    const esportsPage = document.getElementById('esportsPage');
    const historyPage = document.getElementById('historyPage');
    const historyList = document.getElementById('historyList');

    // menu buttons
    document.getElementById('gamesBtn').addEventListener('click', ()=> showPage('mines'));
    document.getElementById('esportsBtn').addEventListener('click', ()=> showPage('esports'));
    document.getElementById('depositBtn').addEventListener('click', ()=> showPage('deposit'));
    document.getElementById('withdrawBtn').addEventListener('click', ()=> showPage('withdraw'));
    document.getElementById('historyBtn').addEventListener('click', ()=> { showPage('history'); loadHistory(); });
    document.getElementById('logoutBtn').addEventListener('click', async ()=> { await signOut(auth); showToast('Logged out'); });

    function showToast(msg){
      toast.textContent=msg;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 2400);
    }
    function showPopup(msg, cls='') {
      popup.textContent = msg;
      popup.className = 'popup-msg';
      if(cls) popup.classList.add(cls);
      popup.classList.remove('hidden');
      setTimeout(()=> popup.classList.add('hidden'), 2400);
    }

    // Tabs
    loginTab.addEventListener('click', ()=>{
      loginTab.classList.add('active');
      registerTab.classList.remove('active');
      loginForm.classList.remove('hidden');
      registerForm.classList.add('hidden');
    });
    registerTab.addEventListener('click', ()=>{
      registerTab.classList.add('active');
      loginTab.classList.remove('active');
      registerForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
    });
    // default tab
    loginTab.click();

    // ---------- UTILS ----------
    function genAccountNumber(){
      // 10-digit account number starting with 7
      return '7' + Math.floor(100000000 + Math.random()*900000000).toString();
    }

    // ---------- Auth handlers ----------
    registerForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;
        const accNo = genAccountNumber();
        // create user doc with zero balance and accountNumber
        await setDoc(doc(db, 'users', uid), {
          email,
          balance: 0,
          accountNumber: accNo,
          createdAt: serverTimestamp()
        });
        // show account number to user
        newAccountEl.textContent = `Your account number: ${accNo} â€” save this for deposits.`;
        newAccountEl.classList.remove('hidden');
        showToast('Registered! Please login');
        loginTab.click();
      } catch(err){
        showPopup('Register error: ' + err.message);
      }
    });

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        showToast('Login successful');
      } catch(err){
        showPopup('Login error: ' + err.message);
      }
    });

    // ---------- Auth state listener ----------
    let currentUser = null;
    let balanceUnsub = null;
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUser = user;
        authView.classList.add('hidden');
        appView.classList.remove('hidden');
        // start realtime balance listener
        if(balanceUnsub) balanceUnsub();
        balanceUnsub = listenToBalance();
        showPage('home');
      } else {
        currentUser = null;
        if(balanceUnsub) { balanceUnsub(); balanceUnsub = null; }
        appView.classList.add('hidden');
        authView.classList.remove('hidden');
      }
    });

    // realtime listener for user document
    function listenToBalance(){
      if(!currentUser) return ()=>{};
      const userRef = doc(db, 'users', currentUser.uid);
      const unsub = onSnapshot(userRef, (snap)=>{
        if(snap.exists()){
          const data = snap.data();
          const bal = data.balance || 0;
          const acc = data.accountNumber || currentUser.uid.substring(0,6);
          accountLabel.textContent = `Account - ${acc}`;
          amountLabel.textContent = `Amount - ${bal} NPR`;
          document.getElementById('gameBalance').textContent = bal.toFixed(2);
        }
      }, (err)=> console.error('balance listener err', err));
      return unsub;
    }

    // ---------- Page navigation ----------
    function hideAllPages(){
      homePage.classList.add('hidden');
      minesPage.classList.add('hidden');
      depositPage.classList.add('hidden');
      withdrawPage.classList.add('hidden');
      esportsPage.classList.add('hidden');
      historyPage.classList.add('hidden');
    }
    function showPage(page){
      hideAllPages();
      if(page === 'home') homePage.classList.remove('hidden');
      if(page === 'mines') {
        minesPage.classList.remove('hidden');
        setupGrid();
      }
      if(page === 'deposit') depositPage.classList.remove('hidden');
      if(page === 'withdraw') withdrawPage.classList.remove('hidden');
      if(page === 'esports') esportsPage.classList.remove('hidden');
      if(page === 'history') historyPage.classList.remove('hidden');
    }

    // ---------- HISTORY ----------
    async function loadHistory(){
      historyList.innerHTML = 'Loading...';
      try {
        const col = collection(db, 'users', currentUser.uid, 'history');
        const q = query(col, orderBy('time','desc'));
        const snap = await getDocs(q);
        historyList.innerHTML = '';
        if(snap.empty){ historyList.innerHTML = '<div class="small">No history</div>'; return; }
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const el = document.createElement('div');
          el.style.padding='10px'; el.style.background='linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02))'; el.style.borderRadius='8px';
          el.innerHTML = `<div style="font-weight:700">${(d.type||'').toUpperCase()} â€” â‚¨ ${d.amount || 0}</div>
            <div class="small">${new Date(d.time?.toMillis?.() || Date.now()).toLocaleString()}</div>
            <div class="small">${d.note || ''}</div>`;
          historyList.appendChild(el);
        });
      } catch(e){
        historyList.innerHTML = '<div class="small">Could not load history</div>';
        console.error(e);
      }
    }

    // ---------- MINES GAME LOGIC (connected to Firestore) ----------
    const gridEl = document.getElementById('grid');
    const betBtn = document.getElementById('betBtn');
    const cashoutBtn = document.getElementById('cashoutBtn');
    const betAmountInput = document.getElementById('betAmount');
    const minesCountSelect = document.getElementById('minesCount');
    const cashoutInfo = document.getElementById('cashoutInfo');
    const halfBtn = document.getElementById('halfBtn');
    const doubleBtn = document.getElementById('doubleBtn');
    const instantMultiplierEl = document.getElementById('instantMultiplier');

    let cells = [];
    let mineIndexes = [];
    let playing = false;
    let bet = 0;
    let winnings = 0;
    let multiplier = 1;
    let safeClicks = 0;

    function setupGrid(){
      gridEl.innerHTML = '';
      cells = [];
      for(let i=0;i<9;i++){
        const c = document.createElement('div');
        c.className='cell';
        c.addEventListener('click', ()=> reveal(i));
        gridEl.appendChild(c);
        cells.push(c);
      }
      updateInstantMultiplier(); // reset display
    }
    setupGrid();

    halfBtn.addEventListener('click', ()=> {
      let amt = parseFloat(betAmountInput.value) || 0;
      betAmountInput.value = Math.max(0, Math.floor(amt/2));
    });
    doubleBtn.addEventListener('click', ()=> {
      let amt = parseFloat(betAmountInput.value) || 0;
      betAmountInput.value = Math.floor(amt*2);
    });

    minesCountSelect.addEventListener('change', updateInstantMultiplier);
    function updateInstantMultiplier(){
      const mines = parseInt(minesCountSelect.value);
      const initial = calcMultiplier(0, mines);
      instantMultiplierEl.textContent = `x${initial.toFixed(2)}`;
    }

    betBtn.addEventListener('click', async function(){
      if(!currentUser){ showPopup('Not authenticated'); return; }
      if(!playing){
        bet = Math.floor(parseFloat(betAmountInput.value) || 0);
        if(bet < 30){ showPopup('Min bet is 30'); return; }
        // run a Firestore transaction to deduct bet atomically
        try{
          await runTransaction(db, async (t)=>{
            const userRef = doc(db, 'users', currentUser.uid);
            const userSnap = await t.get(userRef);
            if(!userSnap.exists()) throw new Error('User doc missing');
            const curBal = userSnap.data().balance || 0;
            if(curBal < bet) throw new Error('Insufficient balance');
            t.update(userRef, { balance: curBal - bet });
            // add history entry for bet
            const histRef = collection(db, 'users', currentUser.uid, 'history');
            const hdoc = doc(histRef);
            t.set(hdoc, { type:'bet', amount: bet, time: serverTimestamp(), note: 'Placed bet' });
          });

          // local UI changes: Start game
          playing = true;
          betBtn.style.display = 'none';
          cashoutBtn.style.display = 'inline-block';
          // set mines
          const mines = parseInt(minesCountSelect.value);
          mineIndexes = [];
          while(mineIndexes.length < mines){
            let r = Math.floor(Math.random()*9);
            if(!mineIndexes.includes(r)) mineIndexes.push(r);
          }
          // reset counters
          winnings = bet;
          multiplier = 1;
          safeClicks = 0;
          cashoutInfo.textContent = `Multiplier: x1.00 | Win: â‚¨ ${winnings}`;
          setupGrid();
          showToast('Bet placed. Good luck!');
        }catch(err){
          showPopup('Transaction error: ' + err.message);
        }
      }
    });

    // Cashout: credit the user's winnings
    cashoutBtn.addEventListener('click', async ()=>{
      if(!playing) return;
      const credit = winnings;
      try{
        await runTransaction(db, async (t)=>{
          const userRef = doc(db, 'users', currentUser.uid);
          const userSnap = await t.get(userRef);
          const curBal = userSnap.data().balance || 0;
          t.update(userRef, { balance: curBal + credit });
          // add history entry
          const histRef = collection(db, 'users', currentUser.uid, 'history');
          const hdoc = doc(histRef);
          t.set(hdoc, { type:'cashout', amount: credit, time: serverTimestamp(), note: 'Cashed out' });
        });
        showPopup('You cashed out â‚¨' + credit, 'popup-win');
        // little win effect
        confettiWin();
        resetGame();
      } catch(e){
        showPopup('Cashout failed: ' + e.message);
      }
    });

    // probability-based multiplier function
    function calcMultiplier(safeRevealed, mines, total=9){
      // multiplier formula: (total - safeRevealed) / (total - mines - safeRevealed)
      // this grows as safeRevealed increases; initial multiplier when safeRevealed=0 is total/(total-mines)
      const numerator = (total - safeRevealed);
      const denom = (total - mines - safeRevealed);
      if(denom <= 0) return numerator; // fallback
      return numerator / denom;
    }

    function reveal(i){
      if(!playing) return;
      const c = cells[i];
      if(c.classList.contains('revealed')) return;
      c.classList.add('revealed');
      // losing condition
      if(mineIndexes.includes(i)){
        c.textContent = 'ðŸ’£';
        c.classList.add('blast');
        // reveal all mines
        mineIndexes.forEach(idx=>{
          if(idx !== i && cells[idx]){
            cells[idx].classList.add('revealed');
            cells[idx].textContent = 'ðŸ’£';
          }
        });
        // record loss in history (we already deducted bet at start)
        (async ()=>{
          try{
            await addDoc(collection(db, 'users', currentUser.uid, 'history'), {
              type: 'lose',
              amount: bet,
              time: serverTimestamp(),
              note: 'Lost bet'
            });
          }catch(e){ console.error('history write failed', e); }
        })();
        showPopup('Boom! You hit a mine', 'popup-lose');
        resetGame();
      } else {
        safeClicks++;
        // recalc multiplier and winnings
        const mines = parseInt(minesCountSelect.value);
        // use safeRevealed-1 because calcMultiplier expects safeRevealed before current reveal logic
        multiplier = calcMultiplier(safeClicks-1, mines);
        winnings = Math.floor(bet * multiplier);
        c.textContent = 'ðŸ’Ž';
        c.classList.add('diamond');
        cashoutInfo.textContent = `Multiplier: x${multiplier.toFixed(2)} | Win: â‚¨ ${winnings}`;
        instantMultiplierEl.textContent = `x${multiplier.toFixed(2)}`;
        // write a small win event to history (optional)
        (async ()=>{
          try{
            await addDoc(collection(db, 'users', currentUser.uid, 'history'), {
              type: 'safe',
              amount: 0,
              time: serverTimestamp(),
              note: `Revealed safe tile â€” multiplier x${multiplier.toFixed(2)}`
            });
          }catch(e){ /*ignore*/ }
        })();
        showPopup('Safe! Current win: â‚¨' + winnings, 'popup-win');
      }
    }

    function resetGame(){
      playing = false;
      bet = 0;
      winnings = 0;
      multiplier = 1;
      safeClicks = 0;
      cashoutInfo.textContent = '';
      betBtn.style.display = 'inline-block';
      cashoutBtn.style.display = 'none';
      setupGrid();
      updateInstantMultiplier();
    }

    // little confetti effect using DOM (no external libs)
    function confettiWin(){
      const conf = document.createElement('div');
      conf.className = 'confetti';
      conf.style.width = '200px'; conf.style.height = '120px';
      conf.style.pointerEvents = 'none';
      conf.innerHTML = Array.from({length:18}).map((_,i)=>{
        const left = Math.random()*100;
        const top = Math.random()*100;
        const size = 6 + Math.random()*10;
        const colors = ['#FFD54A','#FF8A65','#80DEEA','#A5D6A7','#FFCDD2','#CE93D8'];
        const c = colors[Math.floor(Math.random()*colors.length)];
        return `<span style="position:absolute;left:${left}%;top:${top}%;width:${size}px;height:${size}px;background:${c};display:block;border-radius:3px;transform:translateY(-20px);opacity:0;animation:cf 900ms ease forwards ${i*30}ms"></span>`;
      }).join('');
      document.body.appendChild(conf);
      setTimeout(()=> conf.remove(), 1600);
      const style = document.createElement('style');
      style.innerHTML = `@keyframes cf{to{transform:translateY(40px) rotate(30deg);opacity:1}}`;
      document.head.appendChild(style);
      setTimeout(()=> style.remove(), 1600);
    }

    // init
    document.getElementById('gamesBtn').addEventListener('click', ()=> {
      setupGrid();
    });

    // esports -> show coming soon popup
    document.getElementById('esportsBtn').addEventListener('click', ()=> {
      showPopup('eSports coming soon â€” stay tuned!');
    });

    // basic safeguard: do not allow non-auth to access pages
    // (onAuthStateChanged handles UI toggles)

  </script>
</body>
</html>
