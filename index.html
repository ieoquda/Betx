<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BetX ‚Äî Online Gaming</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          bg: '#0b0f1a',
          card: '#12182b',
          neon: '#00ffc6',
          neon2: '#8a5cff'
        }
      }
    }
  }
</script>

<style>
  html, body { height: 100%; background:#0b0f1a; color:#e6e6e6; font-family: ui-sans-serif, system-ui, -apple-system;}
  .screen { display:none; }
  .screen.active { display:block; }
  .card {
    background: linear-gradient(135deg, rgba(18,24,43,.9), rgba(18,24,43,.6));
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 16px; padding:18px; transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 10px 24px rgba(0,0,0,.35);
  }
  .card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,.5); }
  .btn {
    padding:10px 14px; border-radius:12px; font-weight:600; border:1px solid rgba(255,255,255,.08);
    background:linear-gradient(135deg, rgba(0,255,198,.15), rgba(138,92,255,.15));
    backdrop-filter: blur(6px);
    transition: transform 0.2s ease, background 0.2s ease;
  }
  .btn:active { transform: scale(0.98); background:linear-gradient(135deg, rgba(0,255,198,.25), rgba(138,92,255,.25)); }
  .btn:disabled { opacity:.5; cursor:not-allowed;}
  .pill { border-radius:999px; }
  .neon-text { text-shadow: 0 0 12px rgba(0,255,198,.6); }
  .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
  .grid-5 { display:grid; grid-template-columns: repeat(5, 1fr); gap:10px;}
  .tile { aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; border-radius:12px; cursor:pointer;
          background:#0f1526; border:1px solid rgba(255,255,255,.06); user-select:none; 
          transition: transform 0.2s ease, background 0.2s ease; }
  .tile:hover { transform: scale(1.05); }
  .tile.revealed { background:#0d1b2a; animation: revealAnim 0.5s ease; }
  @keyframes revealAnim { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
  .badge { font-size:12px; opacity:.9; }
  /* Loading Spinner */
  #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11,15,26,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
  .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #00ffc6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  /* Aviator Animation */
  #aviatorMult { transition: color 0.3s ease; }
  #aviatorMult.growing { color: #00ffc6; text-shadow: 0 0 8px #00ffc6; }
  /* Dice Roll */
  .dice-rolling { animation: diceRoll 1s ease; }
  @keyframes diceRoll { 0% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } 100% { transform: rotate(360deg); } }
  /* Slots Spin */
  .reel { display: inline-block; width: 1em; text-align: center; animation: slotSpin 1s ease-in-out; }
  @keyframes slotSpin { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
</style>
</head>

<body class="min-h-full">
  <!-- Loading Screen -->
  <div id="loadingScreen" class="screen" style="display:none;">
    <div class="spinner"></div>
    <p class="mt-4 text-sm opacity-80">Loading your account...</p>
  </div>

  <div class="max-w-5xl mx-auto p-4 md:p-6">
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <div class="text-2xl">üé∞</div>
        <h1 class="text-xl md:text-2xl font-bold"><span class="neon-text">BetX</span> ‚Äî Online Gaming</h1>
      </div>
      <div id="userBar" class="hidden items-center gap-3">
        <span class="text-sm opacity-80">
          <span id="helloUser">Hi, --</span> ‚Ä¢ A/C <span id="helloAcc">--</span> ‚Ä¢
          <span id="helloBal" class="font-semibold">0</span> üí∞
        </span>
        <button id="btnRefreshBal" class="btn text-sm">‚ü≥</button>
        <button id="btnSwitch" class="btn text-sm">Switch</button>
        <button id="btnLogout" class="btn text-sm">Logout</button>
      </div>
    </header>

    <section id="authScreen" class="screen active">
      <div class="max-w-md mx-auto card">
        <h2 class="text-2xl font-bold mb-2">Login / Register</h2>
        <p class="text-sm opacity-80 mb-4">One account per device enforced üîí</p>

        <label class="block text-sm mb-1">Username</label>
        <input id="authUsername" class="w-full mb-3 p-3 bg-[#0f1526] border border-white/10 rounded-lg" placeholder="e.g. Aadarsh" />

        <label class="block text-sm mb-1">Email</label>
        <input id="authEmail" type="email" class="w-full mb-3 p-3 bg-[#0f1526] border border-white/10 rounded-lg" placeholder="you@mail.com" />

        <label class="block text-sm mb-1">Password</label>
        <input id="authPassword" type="password" class="w-full mb-4 p-3 bg-[#0f1526] border border-white/10 rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <div class="flex gap-2">
          <button id="btnRegister" class="btn w-full">Create Account</button>
          <button id="btnLogin" class="btn w-full">Login</button>
        </div>

        <div class="mt-4 text-xs opacity-70">
          By continuing you agree to our <b>Terms of Service</b>. All gameplay is for entertainment purposes only.
        </div>
      </div>
    </section>

    <section id="homeScreen" class="screen">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold mb-1">Wallet</h3>
              <div class="text-3xl font-black" id="homeBalance">0</div>
              <div class="text-xs opacity-70">Stored securely ‚Ä¢ Syncs across devices</div>
            </div>
            <div class="text-3xl">üí∞</div>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <button class="btn pill text-sm" onclick="openScreen('depositScreen')">‚ûï Deposit</button>
            <button class="btn pill text-sm" onclick="openScreen('withdrawScreen')">‚Üò Withdraw</button>
            <button class="btn pill text-sm" onclick="openScreen('historyScreen')">üìú History</button>
            <button class="btn pill text-sm" onclick="claimDailyBonus()">üéÅ Daily Bonus</button>
            <button class="btn pill text-sm" onclick="openScreen('leaderboardScreen')">üèÜ Leaderboard</button>
          </div>
        </div>

        <div class="card">
          <h3 class="text-lg font-semibold mb-3">Games</h3>
          <div class="grid grid-cols-2 gap-3">
            <button class="card" onclick="openScreen('minesScreen')">
              <div class="text-3xl mb-1">üíé</div>
              <div class="font-semibold">Mines</div>
              <div class="text-xs opacity-70">Pick safe tiles. Cash out!</div>
            </button>
            <button class="card" onclick="openScreen('aviatorScreen')">
              <div class="text-3xl mb-1">‚úàÔ∏è</div>
              <div class="font-semibold">Aviator</div>
              <div class="text-xs opacity-70">Don‚Äôt crash. Cash out!</div>
            </button>
            <button class="card" onclick="openScreen('diceScreen')">
              <div class="text-3xl mb-1">üé≤</div>
              <div class="font-semibold">Dice</div>
              <div class="text-xs opacity-70">Predict & roll.</div>
            </button>
            <button class="card" onclick="openScreen('slotsScreen')">
              <div class="text-3xl mb-1">üé∞</div>
              <div class="font-semibold">Slots</div>
              <div class="text-xs opacity-70">Spin 3-of-a-kind.</div>
            </button>
            <button class="card" onclick="openScreen('rouletteScreen')">
              <div class="text-3xl mb-1">üõû</div>
              <div class="font-semibold">Roulette</div>
              <div class="text-xs opacity-70">Bet on colors/numbers.</div>
            </button>
            <button class="card" onclick="openScreen('blackjackScreen')">
              <div class="text-3xl mb-1">üÉè</div>
              <div class="font-semibold">Blackjack</div>
              <div class="text-xs opacity-70">Beat the dealer to 21.</div>
            </button>
          </div>
        </div>
      </div>
    </section>

    <section id="depositScreen" class="screen">
      <div class="card max-w-lg mx-auto">
        <button class="btn mb-3" onclick="openScreen('homeScreen')">‚¨Ö Back</button>
        <h2 class="text-xl font-bold mb-2">Deposit</h2>
        <p class="text-sm opacity-80 mb-4">Request a deposit via our official Telegram channel for swift processing.</p>

        <div class="p-4 bg-[#0f1526] rounded-lg border border-white/10">
          <div class="text-sm opacity-80 mb-2">Official Telegram (copy & DM):</div>
          <div class="flex items-center gap-2">
            <input id="tgUser" readonly class="w-full p-3 bg-[#0b0f1a] border border-white/10 rounded-lg" />
            <button class="btn" onclick="copyTg()">Copy</button>
          </div>
        </div>

        <div class="mt-4 text-sm opacity-80">
          Please include your <b>account number</b>: <span class="font-semibold" id="depAcc">--</span>
        </div>
      </div>
    </section>

    <section id="withdrawScreen" class="screen">
      <div class="card max-w-lg mx-auto">
        <button class="btn mb-3" onclick="openScreen('homeScreen')">‚¨Ö Back</button>
        <h2 class="text-xl font-bold mb-2">Withdraw</h2>
        <p class="text-sm opacity-80">
          Request your withdrawal via Telegram. Please include your <b>account number</b> for verification. Withdrawals are processed by our support team.
        </p>
      </div>
    </section>

    <section id="historyScreen" class="screen">
      <div class="card">
        <button class="btn mb-3" onclick="openScreen('homeScreen')">‚¨Ö Back</button>
        <h2 class="text-xl font-bold mb-2">Transaction History</h2>
        <div id="historyList" class="space-y-2 text-sm"></div>
      </div>
    </section>

    <section id="leaderboardScreen" class="screen">
      <div class="card">
        <button class="btn mb-3" onclick="openScreen('homeScreen')">‚¨Ö Back</button>
        <h2 class="text-xl font-bold mb-2">Leaderboard</h2>
        <div class="space-y-2 text-sm">
          <!-- Mock leaderboard, fetch from Firestore in real app -->
          <div class="p-3 rounded-lg bg-white/5 flex justify-between">
            <span>1. PlayerOne</span>
            <span>10,000 üí∞</span>
          </div>
          <div class="p-3 rounded-lg bg-white/5 flex justify-between">
            <span>2. PlayerTwo</span>
            <span>8,500 üí∞</span>
          </div>
          <!-- Add more -->
        </div>
      </div>
    </section>

    <section id="minesScreen" class="screen">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <button class="btn" onclick="openScreen('homeScreen')">‚¨Ö</button>
          <h2 class="text-xl font-bold">üíé Mines</h2>
          <div></div>
        </div>

        <div class="flex items-center gap-2 mb-3">
          <input id="minesBet" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" min="1" placeholder="Bet" />
          <input id="minesAutoCashout" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" step="0.1" min="1" placeholder="Auto Cashout x" />
          <button id="minesStart" class="btn">Start</button>
          <button id="minesCashout" class="btn" disabled>Cashout</button>
        </div>

        <div class="flex items-center gap-2 mb-3">
          <span class="badge px-3 py-1 bg-white/10 pill">Mines:</span>
          <button class="btn text-sm pill" data-mines="1">1</button>
          <button class="btn text-sm pill" data-mines="2">2</button>
          <button class="btn text-sm pill" data-mines="3">3</button>
          <span class="text-xs opacity-70">More mines ‚Üí higher risk/reward</span>
        </div>

        <div id="minesGrid" class="grid-3 mb-3"></div>
        <div id="minesStatus" class="text-sm opacity-80"></div>
      </div>
    </section>

    <section id="aviatorScreen" class="screen">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <button class="btn" onclick="openScreen('homeScreen')">‚¨Ö</button>
          <h2 class="text-xl font-bold">‚úàÔ∏è Aviator</h2>
          <div></div>
        </div>

        <div class="flex items-center gap-2 mb-3">
          <input id="aviatorBet" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" min="1" placeholder="Bet" />
          <input id="aviatorAutoCashout" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" step="0.1" min="1" placeholder="Auto Cashout x" />
          <button id="aviatorStart" class="btn">Start</button>
          <button id="aviatorCashout" class="btn" disabled>Cashout</button>
        </div>

        <div class="text-lg mb-2">Multiplier: <span id="aviatorMult">1.00√ó</span></div>
        <div class="text-sm opacity-80">Cash out before crash to win <span id="aviatorPotential">0</span> üí∞</div>
        <div id="aviatorStatus" class="text-sm opacity-80 mt-2"></div>
        <div class="text-xs opacity-70 mt-2">Recent Crashes: <span id="aviatorHistory">--</span></div>
      </div>
    </section>

    <section id="diceScreen" class="screen">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <button class="btn" onclick="openScreen('homeScreen')">‚¨Ö</button>
          <h2 class="text-xl font-bold">üé≤ Dice</h2>
          <div></div>
        </div>

        <div class="flex items-center gap-2 mb-3">
          <input id="diceBet" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" min="1" placeholder="Bet" />
          <select id="dicePick" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg">
            <option value="over">Over 3.5 (√ó1.9)</option>
            <option value="under">Under 3.5 (√ó1.9)</option>
            <option value="even">Even (√ó1.9)</option>
            <option value="odd">Odd (√ó1.9)</option>
            <option value="exact1">Exact 1 (√ó5.8)</option>
            <option value="exact2">Exact 2 (√ó5.8)</option>
            <option value="exact3">Exact 3 (√ó5.8)</option>
            <option value="exact4">Exact 4 (√ó5.8)</option>
            <option value="exact5">Exact 5 (√ó5.8)</option>
            <option value="exact6">Exact 6 (√ó5.8)</option>
          </select>
          <button id="dicePlay" class="btn">Play</button>
        </div>

        <div id="diceResult" class="text-sm opacity-80 text-3xl mb-1 dice-rolling"></div>
      </div>
    </section>

    <section id="slotsScreen" class="screen">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <button class="btn" onclick="openScreen('homeScreen')">‚¨Ö</button>
          <h2 class="text-xl font-bold">üé∞ Slots</h2>
          <div></div>
        </div>

        <div class="flex items-center gap-2 mb-3">
          <input id="slotsBet" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" min="1" placeholder="Bet" />
          <button id="slotsSpin" class="btn">Spin</button>
        </div>

        <div class="text-3xl font-bold mb-1" id="slotsReels">‚Äî ‚Ä¢ ‚Äî ‚Ä¢ ‚Äî</div>
        <div id="slotsStatus" class="text-sm opacity-80"></div>
        <div class="text-xs opacity-70 mt-2">Paytable: 3-of-a-kind √ó6, 2-of-a-kind √ó2</div>
      </div>
    </section>

    <section id="rouletteScreen" class="screen">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <button class="btn" onclick="openScreen('homeScreen')">‚¨Ö</button>
          <h2 class="text-xl font-bold">üõû Roulette</h2>
          <div></div>
        </div>

        <div class="flex items-center gap-2 mb-3">
          <input id="rouletteBet" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" min="1" placeholder="Bet" />
          <select id="roulettePick" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg">
            <option value="red">Red (√ó2)</option>
            <option value="black">Black (√ó2)</option>
            <option value="even">Even (√ó2)</option>
            <option value="odd">Odd (√ó2)</option>
            <option value="low">1-18 (√ó2)</option>
            <option value="high">19-36 (√ó2)</option>
            <option value="number">Exact Number (√ó36)</option>
          </select>
          <input id="rouletteNumber" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" min="0" max="36" placeholder="Number (if exact)" style="display:none;" />
          <button id="roulettePlay" class="btn">Spin</button>
        </div>

        <div id="rouletteResult" class="text-sm opacity-80 text-3xl mb-1 dice-rolling"></div> <!-- Reusing dice animation for spin -->
      </div>
    </section>

    <section id="blackjackScreen" class="screen">
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <button class="btn" onclick="openScreen('homeScreen')">‚¨Ö</button>
          <h2 class="text-xl font-bold">üÉè Blackjack</h2>
          <div></div>
        </div>

        <div class="flex items-center gap-2 mb-3">
          <input id="blackjackBet" class="p-2 bg-[#0f1526] border border-white/10 rounded-lg w-32" type="number" min="1" placeholder="Bet" />
          <button id="blackjackStart" class="btn">Deal</button>
        </div>

        <div class="mb-3">
          <div>Dealer: <span id="blackjackDealerHand"></span></div>
          <div>Your Hand: <span id="blackjackPlayerHand"></span> (Score: <span id="blackjackPlayerScore">0</span>)</div>
        </div>

        <div class="flex gap-2">
          <button id="blackjackHit" class="btn" disabled>Hit</button>
          <button id="blackjackStand" class="btn" disabled>Stand</button>
        </div>

        <div id="blackjackStatus" class="text-sm opacity-80 mt-2"></div>
      </div>
    </section>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  // ========= CONFIG =========
  const TELEGRAM_USERNAME = "@YourTelegram"; // <-- IMPORTANT: Set your Telegram username here
  const DEVICE_LOCK_KEY = "betx_account_number";

  // Implemented your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyChhpAI9dKSinSqopaUHqwRSKxCRiwy92Q",
    authDomain: "betx-5852a.firebaseapp.com",
    projectId: "betx-5852a",
    storageBucket: "betx-5852a.appspot.com",
    messagingSenderId: "1034960375081",
    appId: "1:1034960375081:web:895d96c37d13e236fc7b38",
    measurementId: "G-X8SD5DC9RY"
  };

  // ========= Firebase =========
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ========= State =========
  let current = { uid:null, accountNumber:null, username:null, balance:0 };
  let lastBonusClaim = localStorage.getItem('lastBonusClaim');

  // ========= UI Helpers =========
  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));
  function openScreen(id) {
    qsa('.screen').forEach(s => s.classList.remove('active'));
    qs('#' + id).classList.add('active');
    if (id === 'homeScreen') refreshBalance();
    if (id === 'historyScreen') loadHistory();
    if (id === 'leaderboardScreen') loadLeaderboard();
  }
  function setHeader() {
    if (!current.uid) { qs('#userBar').classList.add('hidden'); return; }
    qs('#userBar').classList.remove('hidden');
    qs('#helloUser').textContent = current.username ?? '--';
    qs('#helloAcc').textContent = current.accountNumber ?? '--';
    qs('#helloBal').textContent = current.balance.toFixed(2);
    qs('#homeBalance').textContent = current.balance.toFixed(2);
    qs('#depAcc').textContent = current.accountNumber ?? '--';
    qs('#tgUser').value = TELEGRAM_USERNAME;
  }
  function toast(msg){ alert(msg); }
  function copyTg(){ navigator.clipboard.writeText(TELEGRAM_USERNAME).then(()=>toast('Copied Telegram username')); }
  function showLoading() {
    qs('#loadingScreen').style.display = 'flex';
  }
  function hideLoading() {
    qs('#loadingScreen').style.display = 'none';
  }

  // ========= Account Number =========
  function generateAccountNumber() {
    const rand = Math.floor(Math.random()*1e9).toString().padStart(9,'0');
    return "9" + rand;
  }

  // ========= Firestore Helpers =========
  async function getUserDoc(uid) { return db.collection('users').doc(uid).get(); }

  async function createUserDoc(uid, username, email) {
    const accountNumber = generateAccountNumber();
    const userRef = db.collection('users').doc(uid);
    await userRef.set({
      accountNumber,
      username,
      email: email || null,
      balance: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      totalWins: 0 // For leaderboard
    });
    return accountNumber;
  }

  function logTx({accountNumber, type, amount, admin=null}) {
    const ref = db.collection('transactions').doc();
    return ref.set({
      id: ref.id,
      accountNumber,
      type,
      amount: Number(amount),
      date: firebase.firestore.FieldValue.serverTimestamp(),
      admin
    });
  }

  async function refreshBalance() {
    if (!current.uid) return;
    const snap = await getUserDoc(current.uid);
    if (snap.exists) {
      current.balance = Number(snap.data().balance || 0);
      current.totalWins = Number(snap.data().totalWins || 0);
      setHeader();
    }
  }

  async function placeBet(amount) {
    amount = Number(amount);
    if (amount <= 0) throw new Error("Invalid bet.");
    const userRef = db.collection('users').doc(current.uid);
    await db.runTransaction(async (tx) => {
      const snap = await tx.get(userRef);
      const bal = Number(snap.data().balance || 0);
      if (bal < amount) throw new Error("Insufficient balance");
      tx.update(userRef, { balance: bal - amount });
    });
    await logTx({ accountNumber: current.accountNumber, type: 'bet', amount });
    await refreshBalance();
  }

  async function creditWin(amount) {
    amount = Number(amount);
    if (amount <= 0) return;
    const userRef = db.collection('users').doc(current.uid);
    await db.runTransaction(async (tx) => {
      const snap = await tx.get(userRef);
      const bal = Number(snap.data().balance || 0);
      const wins = Number(snap.data().totalWins || 0);
      tx.update(userRef, { balance: bal + amount, totalWins: wins + amount });
    });
    await logTx({ accountNumber: current.accountNumber, type: 'cashout', amount });
    await refreshBalance();
  }

  // ========= Auth + Device Lock =========
  async function afterLogin(uid) {
    showLoading();
    setTimeout(async () => {
      const doc = await getUserDoc(uid);
      if (!doc.exists) throw new Error("User profile missing.");
      const data = doc.data();
      const locked = localStorage.getItem(DEVICE_LOCK_KEY);
      if (locked && locked !== data.accountNumber) {
        await auth.signOut();
        throw new Error(`This device is locked to account ${locked}. Use "Switch" on the locked account or clear storage.`);
      }
      current = {
        uid,
        accountNumber: data.accountNumber,
        username: data.username,
        balance: Number(data.balance || 0),
        totalWins: Number(data.totalWins || 0)
      };
      localStorage.setItem(DEVICE_LOCK_KEY, data.accountNumber);
      setHeader();
      openScreen('homeScreen');
      hideLoading();
    }, 2000);
  }

  async function switchAccount() {
    localStorage.removeItem(DEVICE_LOCK_KEY);
    await auth.signOut();
    current = { uid:null, accountNumber:null, username:null, balance:0 };
    setHeader();
    openScreen('authScreen');
  }

  // ========= Daily Bonus =========
  async function claimDailyBonus() {
    const today = new Date().toDateString();
    if (lastBonusClaim === today) return toast('You already claimed today\'s bonus.');
    const bonus = 50; // Fake bonus amount
    await creditWin(bonus);
    localStorage.setItem('lastBonusClaim', today);
    toast(`Claimed daily bonus: ${bonus} üí∞`);
  }

  // ========= Leaderboard =========
  async function loadLeaderboard() {
    const snap = await db.collection('users').orderBy('totalWins', 'desc').limit(10).get();
    const list = snap.docs.map(d => d.data());
    qs('#historyList').innerHTML = list.map(user => {
      return `<div class="p-3 rounded-lg bg-white/5 flex justify-between">
        <span>${user.username}</span>
        <span>${user.totalWins.toFixed(2)} üí∞</span>
      </div>`;
    }).join('') || '<div class="opacity-70">No leaders yet.</div>';
  }

  // ========= Event Bindings =========
  window.addEventListener('DOMContentLoaded', () => {
    // header buttons
    qs('#btnLogout').addEventListener('click', async () => { await auth.signOut(); switchAccount(); });
    qs('#btnSwitch').addEventListener('click', switchAccount);
    qs('#btnRefreshBal').addEventListener('click', refreshBalance);

    // auth buttons
    qs('#btnRegister').addEventListener('click', async () => {
      const username = qs('#authUsername').value.trim();
      const email = qs('#authEmail').value.trim();
      const pass = qs('#authPassword').value;
      if (!username || !email || !pass) return toast("Fill username, email and password.");
      try {
        if (localStorage.getItem(DEVICE_LOCK_KEY)) {
          return toast("Device already locked to an account. Use Switch to clear.");
        }
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        const accountNumber = await createUserDoc(cred.user.uid, username, email);
        await afterLogin(cred.user.uid);
        toast(`Welcome ${username}! Your account: ${accountNumber}`);
      } catch(e){ toast(e.message); }
    });

    qs('#btnLogin').addEventListener('click', async () => {
      const email = qs('#authEmail').value.trim();
      const pass = qs('#authPassword').value;
      if (!email || !pass) return toast("Email & password required.");
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        await afterLogin(cred.user.uid);
      } catch(e){ toast(e.message); }
    });

    // ==== Mines (3x3) ====
    const minesBtns = qsa('#minesScreen [data-mines]');
    let minesState = { active:false, mines:1, mineMap:new Set(), revealed:new Set(), bet:0, multiplier:1, autoCashout:0 };
    minesBtns.forEach(b => b.addEventListener('click', () => {
      minesState.mines = Number(b.dataset.mines);
      minesBtns.forEach(x => x.classList.remove('ring-2'));
      b.classList.add('ring-2');
    }));
    const grid = qs('#minesGrid');
    function resetMinesGrid() {
      grid.innerHTML = '';
      for (let i=0;i<9;i++){ // 3x3 = 9 tiles
        const t = document.createElement('div');
        t.className = 'tile';
        t.dataset.index = i;
        t.textContent = '‚ùì';
        t.addEventListener('click', onReveal);
        t.addEventListener('touchstart', onReveal); // For tapping
        grid.appendChild(t);
      }
      qs('#minesStatus').textContent = '';
    }
    async function startMines() {
      if (minesState.active) return;
      const bet = Number(qs('#minesBet').value);
      const auto = Number(qs('#minesAutoCashout').value) || 0;
      if (!bet || bet<=0) return toast('Enter bet');
      try {
        await placeBet(bet);
      } catch(e){ return toast(e.message); }

      minesState = { active:true, mines:minesState.mines, mineMap:new Set(), revealed:new Set(), bet, multiplier:1, autoCashout: auto };
      while (minesState.mineMap.size < minesState.mines) {
        minesState.mineMap.add(Math.floor(Math.random()*9)); // Adjust for 9 tiles
      }
      resetMinesGrid();
      qs('#minesCashout').disabled = false;
      qs('#minesStatus').textContent = 'Game started. Pick safe tiles!';
    }
    function onReveal(e){
      if (!minesState.active) return;
      const i = Number(e.currentTarget.dataset.index);
      if (minesState.revealed.has(i)) return;
      const tile = e.currentTarget;
      tile.classList.add('revealed');

      if (minesState.mineMap.has(i)) {
        tile.textContent = 'üí•';
        qs('#minesStatus').textContent = 'Boom! You lost.';
        minesState.active = false;
        qs('#minesCashout').disabled = true;
      } else {
        tile.textContent = 'üíé';
        minesState.revealed.add(i);
        minesState.multiplier = (1 + minesState.revealed.size * (0.3 + (minesState.mines-1)*0.2)); // Adjusted for 3x3
        qs('#minesStatus').textContent = `Safe! Cashout now for ${(minesState.bet*minesState.multiplier).toFixed(2)} üí∞ (√ó${minesState.multiplier.toFixed(2)})`;
        if (minesState.autoCashout > 0 && minesState.multiplier >= minesState.autoCashout) cashoutMines();
      }
    }
    async function cashoutMines(){
      if (!minesState.active) return;
      const win = Number((minesState.bet * minesState.multiplier).toFixed(2));
      minesState.active = false;
      qs('#minesCashout').disabled = true;
      await creditWin(win);
      qs('#minesStatus').textContent = `Cashed out: ${win} üí∞`;
      resetMinesGrid();
    }
    qs('#minesStart').addEventListener('click', startMines);
    qs('#minesCashout').addEventListener('click', cashoutMines);
    resetMinesGrid();

    // ==== Aviator (Improved) ====
    let avi = { active:false, bet:0, mult:1, timer:null, crashAt: 0, autoCashout:0, history: [] };
    function updateAviUI(){
      const multEl = qs('#aviatorMult');
      multEl.textContent = avi.mult.toFixed(2) + '√ó';
      multEl.classList.add('growing');
      setTimeout(() => multEl.classList.remove('growing'), 300);
      const potential = avi.active ? (avi.bet * avi.mult).toFixed(2) : 0;
      qs('#aviatorPotential').textContent = potential;
      qs('#aviatorHistory').textContent = avi.history.slice(-5).map(h => h.toFixed(2) + 'x').join(', ');
    }
    async function startAviator(){
      if (avi.active) return;
      const bet = Number(qs('#aviatorBet').value);
      const auto = Number(qs('#aviatorAutoCashout').value) || 0;
      if (!bet || bet<=0) return toast('Enter bet');
      try { await placeBet(bet); } catch(e){ return toast(e.message); }

      avi = { active:true, bet, mult:1, timer:null, crashAt: 1 + Math.random()*10, autoCashout: auto, history: avi.history }; // Higher crash range
      qs('#aviatorCashout').disabled = false;
      qs('#aviatorStatus').textContent = 'Flying...';
      updateAviUI();
      avi.timer = setInterval(async () => {
        if (!avi.active) return;
        avi.mult += (Math.random()*0.1 + 0.05); // Smoother increment
        updateAviUI();
        if (avi.autoCashout > 0 && avi.mult >= avi.autoCashout) await cashoutAviator();
        if (avi.mult >= avi.crashAt) {
          clearInterval(avi.timer);
          avi.history.push(avi.mult);
          avi.active = false;
          qs('#aviatorCashout').disabled = true;
          qs('#aviatorStatus').textContent = `üí• Crashed at ${avi.mult.toFixed(2)}√ó ‚Äî you lost.`;
        }
      }, 300); // Slower for smoothness
    }
    async function cashoutAviator(){
      if (!avi.active) return;
      avi.active = false;
      clearInterval(avi.timer);
      const win = Number((avi.bet * avi.mult).toFixed(2));
      qs('#aviatorCashout').disabled = true;
      await creditWin(win);
      qs('#aviatorStatus').textContent = `Cashed out: ${win} üí∞ at ${avi.mult.toFixed(2)}√ó`;
    }
    qs('#aviatorStart').addEventListener('click', startAviator);
    qs('#aviatorCashout').addEventListener('click', cashoutAviator);

    // ==== Dice (Improved) ====
    qs('#dicePlay').addEventListener('click', async () => {
      const bet = Number(qs('#diceBet').value);
      const pick = qs('#dicePick').value;
      if (!bet || bet<=0) return toast('Enter bet');
      try { await placeBet(bet); } catch(e){ return toast(e.message); }

      const resultEl = qs('#diceResult');
      resultEl.classList.add('dice-rolling');
      let roll;
      // Simulate rolling
      const rollInterval = setInterval(() => {
        resultEl.textContent = Math.floor(Math.random()*6 + 1);
      }, 100);
      setTimeout(() => {
        clearInterval(rollInterval);
        roll = 1 + Math.floor(Math.random()*6);
        resultEl.textContent = `üé≤ ${roll}`;
        resultEl.classList.remove('dice-rolling');

        let win = false, payoutMultiplier = 1.9;
        if (pick === 'over' && roll > 3) win = true;
        else if (pick === 'under' && roll < 4) win = true;
        else if (pick === 'even' && roll % 2 === 0) win = true;
        else if (pick === 'odd' && roll % 2 === 1) win = true;
        else if (pick === 'low' && roll <= 3) win = true;
        else if (pick === 'high' && roll >= 4) win = true;
        else if (pick.startsWith('exact') && roll === Number(pick.slice(5))) {
          win = true;
          payoutMultiplier = 5.8;
        }

        if (win) {
          const payout = Number((bet * payoutMultiplier).toFixed(2));
          await creditWin(payout);
          resultEl.textContent += ` You win ${payout} üí∞`;
        } else {
          resultEl.textContent += ` You lost.`;
        }
      }, 1500); // 1.5 sec roll animation
    });

    // ==== Slots (Improved) ====
    const icons = ['üçí','üçã','üíé','‚≠ê','7Ô∏è‚É£','üîî','üçâ','üçá','üçä']; // More icons
    qs('#slotsSpin').addEventListener('click', async () => {
      const bet = Number(qs('#slotsBet').value);
      if (!bet || bet<=0) return toast('Enter bet');
      try { await placeBet(bet); } catch(e){ return toast(e.message); }

      const reelsEl = qs('#slotsReels');
      reelsEl.innerHTML = '<span class="reel">‚Äî</span> ‚Ä¢ <span class="reel">‚Äî</span> ‚Ä¢ <span class="reel">‚Äî</span>';
      const reels = qsa('.reel');

      // Spin animation
      const spinInterval = setInterval(() => {
        reels.forEach(r => r.textContent = icons[Math.floor(Math.random()*icons.length)]);
      }, 100);
      setTimeout(() => {
        clearInterval(spinInterval);
        const r = [0,0,0].map(()=> icons[Math.floor(Math.random()*icons.length)]);
        reels[0].textContent = r[0];
        reels[1].textContent = r[1];
        reels[2].textContent = r[2];

        const threeKind = (r[0]===r[1] && r[1]===r[2]);
        const twoKind = (r[0]===r[1] || r[1]===r[2] || r[0]===r[2]);
        if (threeKind) {
          const payout = Number((bet * 6).toFixed(2));
          await creditWin(payout);
          qs('#slotsStatus').textContent = `Jackpot! 3-of-a-kind pays ${payout} üí∞`;
        } else if (twoKind) {
          const payout = Number((bet * 2).toFixed(2));
          await creditWin(payout);
          qs('#slotsStatus').textContent = `Nice! 2-of-a-kind pays ${payout} üí∞`;
        } else {
          qs('#slotsStatus').textContent = `No match ‚Äî better luck.`;
        }
      }, 1500); // 1.5 sec spin
    });

    // ==== Roulette (New Game) ====
    qs('#roulettePlay').addEventListener('click', async () => {
      const bet = Number(qs('#rouletteBet').value);
      const pick = qs('#roulettePick').value;
      const number = Number(qs('#rouletteNumber').value);
      if (!bet || bet<=0) return toast('Enter bet');
      if (pick === 'number' && (number < 0 || number > 36)) return toast('Enter number 0-36');
      try { await placeBet(bet); } catch(e){ return toast(e.message); }

      const resultEl = qs('#rouletteResult');
      resultEl.classList.add('dice-rolling');
      let roll;
      const rollInterval = setInterval(() => {
        resultEl.textContent = Math.floor(Math.random()*37);
      }, 100);
      setTimeout(() => {
        clearInterval(rollInterval);
        roll = Math.floor(Math.random()*37);
        const color = roll === 0 ? 'green' : (roll % 2 === 0 ? 'black' : 'red');
        resultEl.textContent = `${roll} (${color})`;
        resultEl.classList.remove('dice-rolling');

        let win = false, payoutMultiplier = 2;
        if (pick === 'red' && color === 'red') win = true;
        else if (pick === 'black' && color === 'black') win = true;
        else if (pick === 'even' && roll % 2 === 0 && roll !== 0) win = true;
        else if (pick === 'odd' && roll % 2 === 1) win = true;
        else if (pick === 'low' && roll >= 1 && roll <= 18) win = true;
        else if (pick === 'high' && roll >= 19 && roll <= 36) win = true;
        else if (pick === 'number' && roll === number) {
          win = true;
          payoutMultiplier = 36;
        }

        if (win) {
          const payout = Number((bet * payoutMultiplier).toFixed(2));
          await creditWin(payout);
          resultEl.textContent += ` You win ${payout} üí∞`;
        } else {
          resultEl.textContent += ` You lost.`;
        }
      }, 1500);
    });
    qs('#roulettePick').addEventListener('change', (e) => {
      qs('#rouletteNumber').style.display = e.target.value === 'number' ? 'block' : 'none';
    });

    // ==== Blackjack (New Game) ====
    let bj = { active: false, bet: 0, playerHand: [], dealerHand: [], deck: [] };
    function createDeck() {
      const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
      const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
      const deck = [];
      for (let suit of suits) {
        for (let rank of ranks) {
          deck.push({ rank, suit });
        }
      }
      return deck.sort(() => Math.random() - 0.5);
    }
    function getScore(hand) {
      let score = 0, aces = 0;
      for (let card of hand) {
        if (card.rank === 'A') aces++;
        else if (['J', 'Q', 'K'].includes(card.rank)) score += 10;
        else score += Number(card.rank);
      }
      for (let i = 0; i < aces; i++) score += (score + 11 <= 21) ? 11 : 1;
      return score;
    }
    function updateBjUI() {
      qs('#blackjackPlayerHand').textContent = bj.playerHand.map(c => c.rank + c.suit).join(' ');
      qs('#blackjackPlayerScore').textContent = getScore(bj.playerHand);
      qs('#blackjackDealerHand').textContent = bj.dealerHand.map((c, i) => i === 0 ? '??' : c.rank + c.suit).join(' ');
      if (getScore(bj.playerHand) > 21) {
        qs('#blackjackStatus').textContent = 'Bust! You lost.';
        endBjGame(false);
      }
    }
    async function startBlackjack() {
      if (bj.active) return;
      const bet = Number(qs('#blackjackBet').value);
      if (!bet || bet <= 0) return toast('Enter bet');
      try { await placeBet(bet); } catch(e){ return toast(e.message); }

      bj = { active: true, bet, playerHand: [], dealerHand: [], deck: createDeck() };
      bj.playerHand.push(bj.deck.pop(), bj.deck.pop());
      bj.dealerHand.push(bj.deck.pop(), bj.deck.pop());
      updateBjUI();
      qs('#blackjackHit').disabled = false;
      qs('#blackjackStand').disabled = false;
      qs('#blackjackStatus').textContent = 'Your turn: Hit or Stand?';
      if (getScore(bj.playerHand) === 21) {
        qs('#blackjackStatus').textContent = 'Blackjack! You win.';
        await creditWin(bet * 1.5);
        endBjGame(true);
      }
    }
    async function hit() {
      if (!bj.active) return;
      bj.playerHand.push(bj.deck.pop());
      updateBjUI();
    }
    async function stand() {
      if (!bj.active) return;
      qs('#blackjackHit').disabled = true;
      qs('#blackjackStand').disabled = true;
      qs('#blackjackDealerHand').textContent = bj.dealerHand.map(c => c.rank + c.suit).join(' ');
      while (getScore(bj.dealerHand) < 17) {
        bj.dealerHand.push(bj.deck.pop());
        qs('#blackjackDealerHand').textContent = bj.dealerHand.map(c => c.rank + c.suit).join(' ');
      }
      const playerScore = getScore(bj.playerHand);
      const dealerScore = getScore(bj.dealerHand);
      if (dealerScore > 21 || playerScore > dealerScore) {
        qs('#blackjackStatus').textContent = 'You win!';
        await creditWin(bj.bet * 2);
      } else if (playerScore === dealerScore) {
        qs('#blackjackStatus').textContent = 'Push - tie.';
        await creditWin(bj.bet); // Refund bet
      } else {
        qs('#blackjackStatus').textContent = 'Dealer wins.';
      }
      endBjGame();
    }
    function endBjGame() {
      bj.active = false;
      qs('#blackjackHit').disabled = true;
      qs('#blackjackStand').disabled = true;
    }
    qs('#blackjackStart').addEventListener('click', startBlackjack);
    qs('#blackjackHit').addEventListener('click', hit);
    qs('#blackjackStand').addEventListener('click', stand);

    // Telegram copy
    window.copyTg = copyTg;

    // auth changes
    auth.onAuthStateChanged(async (u) => {
      if (!u) {
        openScreen('authScreen');
        return;
      }
      try { await afterLogin(u.uid); } catch(e){ toast(e.message); }
    });
  });
  </script>
</body>
</html>
